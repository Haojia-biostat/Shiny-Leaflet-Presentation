---
title: "Intro to Shiny and Leaflet "
author: "Haojia Li"
date: "`r Sys.Date()`"
output: 
  html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = F, message = F, cache = F)
```

Resources:

* [Leaflet for R](https://rstudio.github.io/leaflet/)
* [Shiny Gallery](https://shiny.rstudio.com/gallery/)
* [Shiny Learning Resources](https://shiny.rstudio.com/tutorial/)
* [shinyWidgets](https://shinyapps.dreamrs.fr/shinyWidgets/)

# Prepare data

```{r load met and station}
library(data.table)
# ---- met data ----
met <- fread("https://raw.githubusercontent.com/USCbiostats/data-science-data/master/02_met/met_all.gz")
# select columns
met <- met[, .(USAFID, day, hour, wind.sp, temp, dew.point, atm.press, rh)]

# ---- station data ----
stations <- fread("ftp://ftp.ncdc.noaa.gov/pub/data/noaa/isd-history.csv")
# filter stations in US and select relevant columns
stations <- stations[CTRY == "US", .(USAF, `STATION NAME`, STATE, LAT, LON)]

# drop NAs (999999) in USAF
stations[, USAF := as.integer(USAF)]
stations[, USAF := fifelse(USAF == 999999, NA_integer_, USAF)]
stations <- stations[!is.na(USAF)]

# drop NAs in STATE
stations[, STATE := fifelse(STATE == "", NA_character_, STATE)]
stations <- stations[!is.na(STATE)]

# keep only one data point for each USAF
stations[, n := 1:.N, by = .(USAF)]
stations <- stations[n == 1,][, n := NULL]

# ---- merge data ----
met <- merge(met, stations, by.x = "USAFID", by.y = "USAF", all.x = T)
save(met, file = "met.RData")
```

Calculate median values of weather conditions at station, state and country level.

```{r}
weathers_var <- c("wind.sp", "temp", "dew.point", "atm.press", "rh")
weathers_label <- c("Wind speed", "Temperature", "Dew point", "Atmospheric pressure", "Relative humidity")
weathers_unit <- c(" km/h", "&#8451;", "&#8451;", " hPa", "%")

# number of records and median value of weathers at station level
met_station <- met[, c(.N, lapply(.SD, median, na.rm = T)), 
                   by = .(USAFID, STATE, `STATION NAME`, LON, LAT), 
                   .SDcols = weathers_var]

# median value of weathers at state level
met_state <- met[, lapply(.SD, median, na.rm = T), 
                 by = STATE, 
                 .SDcols = weathers_var]
# merge state-level median values
met_station <- merge(met_station, met_state, 
                     by = "STATE", 
                     suffixes = c(".station", ".state"))

# median value of weathers at country level
met_us <- met[, lapply(.SD, median, na.rm = T), 
              .SDcols = weathers_var]
# add suffix
colnames(met_us) <- paste0(colnames(met_us), ".us")
# merge country-level median values
met_station <- cbind(met_station, met_us)

knitr::kable(met_station) |>
  kableExtra::kable_styling() |>
  kableExtra::scroll_box(width = "100%", height = "300px")
```

Write a function to identify the top representative station(s), at either state or country level, in terms of user-specified weather condition(s) by euclidean distance.

```{r}
sta_represent <- function(
    weathers, # weather conditions of interest
    top_n = 1, # number of representative stations
    top_perc = 10, # upper limit of percentage for representatives
    level = c("state", "us") # at which level to identify representatives
) {
  level <- match.arg(level)
  
  fdata <- copy(met_station)
  fdata$weather_dist <- sqrt(rowSums(
    (as.matrix(fdata[, paste0(weathers, ".", "station"), with = F]) - 
       as.matrix(fdata[, paste0(weathers, ".", level), with = F])) ^ 2,
  ))
  
  if(level == "state") {
    res <- fdata[order(weather_dist), 
                 head(.SD, min(top_n, ceiling(.N * top_perc/100))), 
                 by = STATE]
  }
  if(level == "us") {
    res <- fdata[order(weather_dist), 
                 head(.SD, min(top_n, ceiling(.N * top_perc/100)))]
  }
  
  res$text <- paste0(
    "USAFID: ", res$USAFID, "<br>", 
    "Name: ", res$`STATION NAME`, "<br>",
    "Number of records: ", res$N, "<br>",
    sapply(weathers, \(x) {
      paste0(weathers_label[match(x, weathers_var)], ": ",
             unlist(res[, paste0(x, ".station"), with = F]) |> round(1),
             weathers_unit[match(x, weathers_var)], "<br>")
    }) |> apply(1, paste, collapse = ""),
    "Distance score: ", round(res$weather_dist, 1)
  )
  
  res <- res[!is.na(weather_dist), ]
  return(res)
}
```

# Leaflet

Load [`leaflet`](https://rstudio.github.io/leaflet/) package.

```{r}
if(!require("leaflet", quietly = TRUE)) 
  install.packages("leaflet")
library(leaflet)
```

Data

From base R:

- lng/lat matrix
- data frame with lng/lat columns

From the sp package:

- SpatialPoints[DataFrame]
- Line/Lines
- SpatialLines[DataFrame]
- Polygon/Polygons
- SpatialPolygons[DataFrame]

From the maps package:

- the data frame from returned from map()

```{r out.width="100%"}
leaflet() |> addTiles()
```

There are `r length(providers)` [leaflet providers](https://leaflet-extras.github.io/leaflet-providers/preview/)

```{r out.width="100%"}
m <- leaflet() |> addProviderTiles("CartoDB.Positron")
m
m |> 
  setView(lng = -111.8272, lat = 40.7648, zoom = 16) |>
  addEasyButton(easyButton(
    icon="fa-globe", title="Zoom to Level 4",
    onClick=JS("function(btn, map){ map.setZoom(4); }")
  )) |>
  addEasyButton(easyButton(
    icon="fa-crosshairs", title="Locate Me",
    onClick=JS("function(btn, map){ map.locate({setView: true}); }")
  ))
```


```{r out.width="100%"}
all_us5 <- sta_represent(weathers = weathers_var, top_n = 5, level = "us")

m <- m |>
  addMarkers(
    data = all_us5, 
    lng = ~LON, lat = ~LAT, popup = ~text,
    group = "All"
  )
m
```

```{r out.width="100%"}
all_state10 <- sta_represent(weathers = weathers_var, top_n = 10)

library(RColorBrewer)
dist.pal <- colorNumeric(palette = "YlGnBu", domain = c(0,10))

m <- m |>
  addCircles(
    data = all_state10, 
    lng = ~LON, lat = ~LAT, popup = ~text,
    weight = 1, radius = ~N*100,
    fillOpacity = 0.8, color = ~dist.pal(weather_dist), 
    group = "All"
  ) |>
  addLegend(
    position = "bottomleft", 
    pal = dist.pal, values = c(0, 10), opacity = 1, 
    title = "Distance score"
  )
m
```

```{r out.width="100%"}
each_us3_list <- lapply(weathers_var, sta_represent, top_n = 3, level = "us")
each_state1_list <- lapply(weathers_var, sta_represent)

for(i in 1:length(weathers_var)) {
  m <- m |>
    addMarkers(
      data = each_us3_list[[i]], 
      lng = ~LON, lat = ~LAT, popup = ~text, 
      group = weathers_label[i]
    ) |>
    addCircles(
      data = each_state1_list[[i]], 
      lng = ~LON, lat = ~LAT, popup = ~text, 
      weight = 1, radius = ~N*100, 
      fillOpacity = 0.8, color = ~dist.pal(weather_dist), 
      group = weathers_label[i]
    )
}  

m <- m |>
  addLayersControl(
    baseGroups = c("All", weathers_label), 
    position = "bottomright",
    options = layersControlOptions(collapsed = F)
  )

m
```

Add plot as popup

Save leaflet as image
